<!DOCTYPE HTML>
<!--
	Spectral by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Drunk Detect</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="{{ url_for('static', filename='assets/css/main.css') }}" />
		<noscript><link rel="stylesheet" href="{{ url_for('static', filename='assets/css/noscript.css') }}" /></noscript>
	</head>
	<body class="is-preload">

		<!-- Page Wrapper -->
			<div id="page-wrapper">

				<!-- Header -->
					<header id="header">
						<h1><a href="{{ url_for('main') }}">DrunkGuard</a></h1>
						<nav id="nav">
							<ul>
								<li class="special">
									<a href="#menu" class="menuToggle"><span>Menu</span></a>
									<div id="menu">
										<ul>
											<li><a href="{{ url_for('main') }}">Home</a></li>
											<li><a href="{{ url_for('detect') }}">Detect</a></li>
											{% if logged_in %}
												<li><a href="{{ url_for('log') }}">Log</a></li>
												<li><a href="#" onclick="logout()">Logout ({{ nickname }})</a></li>
											{% else %}
												<li><a href="{{ url_for('login') }}">Login</a></li>
												<li><a href="{{ url_for('signup') }}">Signup</a></li>
											{% endif %}
										</ul>
									</div>
								</li>
							</ul>
						</nav>
					</header>

				<!-- Main -->
					<article id="main">
						<header>
							<h2>Drunk detection</h2>
							<p>Drunk detection using EfficientNet</p>
						</header>
						<section class="wrapper style5">
							<div class="inner" style="text-align: center;">
								<div class="camera-container" style="display: inline-block; border: 3px solid #333; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.3); position: relative;">
									<video id="videoElement" autoplay playsinline width="640" height="480" style="display: none;"></video>
									<canvas id="canvasElement" width="640" height="480" style="display: block;"></canvas>
									<div id="statusOverlay" style="position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 5px; font-weight: bold;">
										<div id="statusText">카메라 접근 중...</div>
									</div>
								</div>
								<div style="margin-top: 20px;">
									<p id="detectionStatus" style="color: #666; font-size: 0.9em;">카메라 접근 중...</p>
									
									<!-- 임계값 조절 UI -->
									<div style="margin-top: 15px; padding: 15px; background-color: #f8f8f8; border-radius: 8px; border: 1px solid #ddd;">
										<h4 style="margin-bottom: 10px; color: #333;">감지 민감도 조절</h4>
										<div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
											<label for="threshold" style="color: #666; font-weight: bold;">임계값:</label>
											<input type="range" id="threshold" name="threshold" min="0.1" max="0.9" step="0.1" value="0.7" 
												   style="width: 200px;" onchange="updateThreshold(this.value)">
											<span id="thresholdValue" style="color: #333; font-weight: bold; min-width: 40px;">0.7</span>
										</div>
										<div style="margin-top: 8px; font-size: 0.8em; color: #888;">
											<span style="float: left;">높은 민감도 (0.1)</span>
											<span style="float: right;">낮은 민감도 (0.9)</span>
										</div>
										<div style="clear: both;"></div>
										<p style="margin-top: 10px; font-size: 0.8em; color: #666;">
											<strong>현재 설정:</strong> <span id="currentThreshold">0.7</span> 
											(값이 높을수록 오탐율 감소, 값이 낮을수록 탐지율 증가)
										</p>
									</div>
								</div>
							</div>
						</section>
					</article>

				<!-- Footer -->
					<footer id="footer">
						<ul class="icons">
							<li><a href="#" class="icon brands fa-twitter"><span class="label">Twitter</span></a></li>
							<li><a href="#" class="icon brands fa-facebook-f"><span class="label">Facebook</span></a></li>
							<li><a href="#" class="icon brands fa-instagram"><span class="label">Instagram</span></a></li>
							<li><a href="#" class="icon brands fa-dribbble"><span class="label">Dribbble</span></a></li>
							<li><a href="#" class="icon solid fa-envelope"><span class="label">Email</span></a></li>
						</ul>
						<ul class="copyright">
							<li>&copy; DrunkGuard</li><li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
						</ul>
					</footer>

			</div>

		<!-- Scripts -->
			<script src="{{ url_for('static', filename='assets/js/jquery.min.js') }}"></script>
			<script src="{{ url_for('static', filename='assets/js/jquery.scrollex.min.js') }}"></script>
			<script src="{{ url_for('static', filename='assets/js/jquery.scrolly.min.js') }}"></script>
			<script src="{{ url_for('static', filename='assets/js/browser.min.js') }}"></script>
			<script src="{{ url_for('static', filename='assets/js/breakpoints.min.js') }}"></script>
			<script src="{{ url_for('static', filename='assets/js/util.js') }}"></script>
			<script src="{{ url_for('static', filename='assets/js/main.js') }}"></script>
			
			<script>
				let videoElement = null;
				let canvasElement = null;
				let ctx = null;
				let isDetecting = false;
				let detectionInterval = null;
				let lastDetectionTime = 0;
				const DETECTION_INTERVAL = 2000; // 2초마다 탐지
				
				// 페이지 로드 시 초기화
				$(document).ready(function() {
					getCurrentThreshold();
					initCamera();
				});
				
				// 카메라 초기화
				function initCamera() {
					videoElement = document.getElementById('videoElement');
					canvasElement = document.getElementById('canvasElement');
					ctx = canvasElement.getContext('2d');
					
					// 로컬 카메라 스트림 시도
					checkLocalCamera();
				}
				
				// 로컬 카메라 확인 (로컬 환경)
				function checkLocalCamera() {
					fetch('/video_feed')
						.then(response => {
							if (response.ok) {
								// 로컬 카메라 사용 가능
								videoElement.src = '/video_feed';
								videoElement.style.display = 'block';
								canvasElement.style.display = 'none';
								updateStatus('로컬 카메라 모드', 'success');
								document.getElementById('detectionStatus').textContent = '실시간 음주 감지 중...';
							} else {
								// 클라우드 환경 - 클라이언트 카메라 사용
								startClientCamera();
							}
						})
						.catch(error => {
							// 클라우드 환경 - 클라이언트 카메라 사용
							startClientCamera();
						});
				}
				
				// 클라이언트 카메라 시작
				function startClientCamera() {
					navigator.mediaDevices.getUserMedia({ 
						video: { 
							width: 640, 
							height: 480,
							facingMode: 'user' 
						} 
					})
					.then(stream => {
						videoElement.srcObject = stream;
						videoElement.style.display = 'block';
						canvasElement.style.display = 'block';
						updateStatus('카메라 준비 완료', 'success');
						document.getElementById('detectionStatus').textContent = '클라이언트 카메라 모드 - 탐지 시작...';
						startDetection();
					})
					.catch(error => {
						console.error('카메라 접근 실패:', error);
						updateStatus('카메라 접근 실패', 'error');
						document.getElementById('detectionStatus').textContent = '카메라 접근 권한이 필요합니다.';
						alert('카메라 접근 권한이 필요합니다. 브라우저 설정에서 카메라 권한을 허용해주세요.');
					});
				}
				
				// 상태 업데이트
				function updateStatus(text, type) {
					const statusDiv = document.getElementById('statusText');
					statusDiv.textContent = text;
					if (type === 'success') {
						statusDiv.style.color = '#00ff00';
					} else if (type === 'error') {
						statusDiv.style.color = '#ff0000';
					} else {
						statusDiv.style.color = '#ffff00';
					}
				}
				
				// 탐지 시작
				function startDetection() {
					if (isDetecting) return;
					isDetecting = true;
					
					// 캔버스에 비디오 프레임 그리기
					function drawFrame() {
						if (videoElement.readyState === videoElement.HAVE_ENOUGH_DATA) {
							ctx.drawImage(videoElement, 0, 0, 640, 480);
						}
						requestAnimationFrame(drawFrame);
					}
					drawFrame();
					
					// 주기적으로 탐지 실행
					detectionInterval = setInterval(() => {
						captureAndDetect();
					}, DETECTION_INTERVAL);
					
					// 첫 탐지 즉시 실행
					captureAndDetect();
				}
				
				// 이미지 캡처 및 탐지
				function captureAndDetect() {
					if (videoElement.readyState !== videoElement.HAVE_ENOUGH_DATA) {
						return;
					}
					
					try {
						// 캔버스에서 이미지 추출
						const imageData = canvasElement.toDataURL('image/jpeg', 0.8);
						
						// 서버로 전송
						fetch('/predict_image', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
							},
							body: JSON.stringify({
								image: imageData
							})
						})
						.then(response => response.json())
						.then(data => {
							if (data.success) {
								const label = data.label;
								const color = label === 'Drunk' ? '#ff0000' : '#00ff00';
								
								// 상태 업데이트
								updateStatus(`탐지 결과: ${label}`, label === 'Drunk' ? 'error' : 'success');
								document.getElementById('detectionStatus').textContent = 
									`최근 탐지: ${label} (${data.location || 'Unknown'})`;
								
								// 결과에 따른 시각적 피드백
								if (label === 'Drunk') {
									canvasElement.style.border = '5px solid #ff0000';
									setTimeout(() => {
										canvasElement.style.border = '3px solid #333';
									}, 1000);
								} else {
									canvasElement.style.border = '3px solid #00ff00';
									setTimeout(() => {
										canvasElement.style.border = '3px solid #333';
									}, 500);
								}
							} else {
								console.error('탐지 실패:', data.message);
								updateStatus('탐지 실패', 'error');
							}
						})
						.catch(error => {
							console.error('탐지 요청 오류:', error);
							updateStatus('서버 오류', 'error');
						});
					} catch (error) {
						console.error('이미지 캡처 오류:', error);
					}
				}
				
				// 페이지 종료 시 정리
				window.addEventListener('beforeunload', () => {
					if (detectionInterval) {
						clearInterval(detectionInterval);
					}
					if (videoElement && videoElement.srcObject) {
						const tracks = videoElement.srcObject.getTracks();
						tracks.forEach(track => track.stop());
					}
				});
				
				// 임계값 업데이트 함수
				function updateThreshold(value) {
					document.getElementById('thresholdValue').textContent = value;
					document.getElementById('currentThreshold').textContent = value;
					
					// 서버에 임계값 전송
					fetch('/set_threshold', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/x-www-form-urlencoded',
						},
						body: 'threshold=' + value
					})
					.then(response => response.json())
					.then(data => {
						if (data.success) {
							console.log('임계값 업데이트 성공:', data.message);
						} else {
							console.error('임계값 업데이트 실패:', data.message);
							alert('임계값 업데이트에 실패했습니다: ' + data.message);
						}
					})
					.catch(error => {
						console.error('오류:', error);
						alert('임계값 업데이트 중 오류가 발생했습니다.');
					});
				}
				
				// 현재 임계값 가져오기 함수
				function getCurrentThreshold() {
					fetch('/get_threshold')
					.then(response => response.json())
					.then(data => {
						if (data.success) {
							const threshold = data.threshold;
							document.getElementById('threshold').value = threshold;
							document.getElementById('thresholdValue').textContent = threshold;
							document.getElementById('currentThreshold').textContent = threshold;
						}
					})
					.catch(error => {
						console.error('현재 임계값 가져오기 실패:', error);
					});
				}
			</script>
			<script src="{{ url_for('static', filename='assets/js/location.js') }}"></script> <!--사용자 현재위치 추적-->
			
			<script>
				function logout() {
					fetch('/logout', { method: 'POST' })
						.then(response => response.json())
						.then(data => {
							if (data.success) {
								location.reload();
							}
						})
						.catch(error => console.error('Logout error:', error));
				}
			</script>

	</body>
</html>